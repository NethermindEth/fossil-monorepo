name: OP Test

on:
  workflow_call:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  STARKNET_RPC_URL: http://127.0.0.1:5050
  STARKNET_PRIVATE_KEY: 0x1
  STARKNET_ACCOUNT_ADDRESS: 0x1
  NETWORK: SEPOLIA

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install required dependencies
        run: sudo apt update && sudo apt install -y libomp-dev libopenblas-dev
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Install sqlx-cli
        run: |
          cargo install sqlx-cli
          sqlx --version

      - name: Sqlx prepare
        run: cd offchain-processor && cargo sqlx prepare --workspace --check
      
      - name: Test
        run: cd offchain-processor && cargo test --workspace --all-targets 